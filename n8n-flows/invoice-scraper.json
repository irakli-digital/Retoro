{
  "nodes": [
    {
      "parameters": {
        "url": "={{ $env.RETORO_API_URL }}/retailers?search={{ encodeURIComponent($json.retailer_name) }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-Key",
              "value": "={{ $json.RETORO_API_KEY }}"
            }
          ]
        },
        "options": {}
      },
      "id": "75c12bea-c6e5-4d5c-91e3-64fd1b77c3fc",
      "name": "Search Retailer",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1280,
        -400
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "LXSAXhTphCOsD48C",
          "name": "Remove BG - IC"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Match retailer from search results\nconst searchResults = $input.item.json;\nconst invoiceRetailerName = $('Parse Invoice Data').item.json.retailer_name.toLowerCase();\n\nlet matchedRetailer = null;\n\nif (searchResults && searchResults.length > 0) {\n  // Try exact match first\n  matchedRetailer = searchResults.find(r => r.name.toLowerCase() === invoiceRetailerName);\n  \n  // Try fuzzy match\n  if (!matchedRetailer) {\n    matchedRetailer = searchResults.find(r => r.name.toLowerCase().includes(invoiceRetailerName) || invoiceRetailerName.includes(r.name.toLowerCase()));\n  }\n  \n  // Take first result if no match\n  if (!matchedRetailer && searchResults.length > 0) {\n    matchedRetailer = searchResults[0];\n  }\n}\n\nif (!matchedRetailer) {\n  throw new Error(`Retailer '${invoiceRetailerName}' not found in database`);\n}\n\nreturn {\n  json: {\n    retailer_id: matchedRetailer.id,\n    retailer_name: matchedRetailer.name,\n    ...$('Parse Invoice Data').item.json\n  }\n};"
      },
      "id": "c09531ca-84f6-4fb2-bdd3-903c3f59a247",
      "name": "Match Retailer",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1456,
        -400
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.RETORO_API_URL }}/return-items",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-API-Key",
              "value": "={{ $env.RETORO_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "retailer_id",
              "value": "={{ $('Match Retailer').item.json.retailer_id }}"
            },
            {
              "name": "name",
              "value": "={{ $json.name }}"
            },
            {
              "name": "price",
              "value": "={{ $json.price }}"
            },
            {
              "name": "purchase_date",
              "value": "={{ $('Match Retailer').item.json.purchase_date }}"
            }
          ]
        },
        "options": {}
      },
      "id": "5466802b-0dfa-477e-943e-6a97740bdee6",
      "name": "Create Return Item",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1904,
        -400
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "LXSAXhTphCOsD48C",
          "name": "Remove BG - IC"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Aggregate results\nconst items = $input.all();\nconst itemsCreated = items.map(item => item.json.id || item.json.item_id);\n\n// Get retailer name from Match Retailer node\nconst retailerName = $('Match Retailer').item.json.retailer_name;\n\nreturn {\n  json: {\n    items_created: itemsCreated,\n    retailer_matched: retailerName,\n    items_count: itemsCreated.length,\n    errors: []\n  }\n};"
      },
      "id": "e5ffbcad-9050-41eb-8fbf-f8d821f9eedb",
      "name": "Aggregate Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2128,
        -400
      ]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "CHATGPT-4O-LATEST"
        },
        "responses": {
          "values": [
            {
              "type": "image",
              "imageType": "base64"
            }
          ]
        },
        "builtInTools": {},
        "options": {}
      },
      "id": "d9c8e8f4-4092-4c56-ad73-192d9f7e7813",
      "name": "Extract Invoice Data with AI",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 2,
      "position": [
        592,
        -304
      ],
      "credentials": {
        "openAiApi": {
          "id": "eJNHP6n8O3Y9Iv2F",
          "name": "Open Ai - IC"
        }
      }
    },
    {
      "parameters": {
        "fieldToSplitOut": "items",
        "include": "allOtherFields",
        "options": {}
      },
      "id": "98c42dee-c8f5-4a8b-b92c-86a77fc40843",
      "name": "Split Items",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        1680,
        -400
      ]
    },
    {
      "parameters": {
        "jsCode": "// Parse OpenAI/Mistral response and extract JSON\nconst input = $input.item.json;\nlet invoiceData;\n\ntry {\n  let content;\n  \n  // Handle different AI response formats\n  if (input.choices && input.choices[0] && input.choices[0].message) {\n    // OpenAI format\n    content = input.choices[0].message.content;\n  } else if (input.extractedText) {\n    // Mistral OCR format\n    content = input.extractedText;\n  } else if (input.message && input.message.content) {\n    content = input.message.content;\n  } else if (input.content) {\n    content = input.content;\n  } else if (typeof input === 'string') {\n    content = input;\n  } else {\n    content = JSON.stringify(input);\n  }\n  \n  // Extract JSON from content (handle markdown code blocks)\n  const jsonMatch = content.match(/```(?:json)?\\s*([\\s\\S]*?)```/) || content.match(/\\{[\\s\\S]*\\}/);\n  \n  if (jsonMatch) {\n    const jsonString = jsonMatch[1] || jsonMatch[0];\n    invoiceData = JSON.parse(jsonString.trim());\n  } else {\n    invoiceData = JSON.parse(content);\n  }\n} catch (e) {\n  throw new Error(`Failed to parse invoice data: ${e.message}. Response: ${JSON.stringify(input)}`);\n}\n\n// Validate required fields\nif (!invoiceData.retailer_name) {\n  throw new Error('Retailer name not found in invoice');\n}\n\nif (!invoiceData.purchase_date) {\n  throw new Error('Purchase date not found in invoice');\n}\n\nif (!invoiceData.items || !Array.isArray(invoiceData.items) || invoiceData.items.length === 0) {\n  throw new Error('No items found in invoice');\n}\n\n// Ensure items have required fields\ninvoiceData.items = invoiceData.items.map(item => ({\n  name: item.name || 'Unnamed Item',\n  price: item.price || 0,\n  quantity: item.quantity || 1\n}));\n\nreturn {\n  json: {\n    retailer_name: invoiceData.retailer_name,\n    purchase_date: invoiceData.purchase_date,\n    order_number: invoiceData.order_number || null,\n    total_amount: invoiceData.total_amount || null,\n    items: invoiceData.items\n  }\n};"
      },
      "id": "parse-invoice-data-node-001",
      "name": "Parse Invoice Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        -400
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b0fd4581-9d46-46c0-8b2f-6dcefab9c854",
              "name": "RETORO_API_KEY",
              "value": "299f5ca754fa16718420949736b75abb139ff5018f792a00c961b99a97716fa7",
              "type": "string"
            },
            {
              "id": "05cf9493-ddc9-47dd-8de8-520eeab97809",
              "name": "RETORO_API_URL",
              "value": "http://localhost:3000/api",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        960,
        -400
      ],
      "id": "d5198ad2-9421-4d20-8c4b-c2eb427591fd",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "invoice-process",
        "responseMode": "lastNode",
        "options": {
          "binaryData": true
        }
      },
      "id": "4b10ece7-12f6-4e75-b4a7-27ce14c867e1",
      "name": "Webhook Trigger1",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        112,
        -400
      ],
      "webhookId": "invoice-process"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "7a9d6b89-5444-4e68-a59a-c61bd33d9ebc",
      "name": "Respond to Webhook1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        2352,
        -400
      ]
    },
    {
      "parameters": {
        "documentType": "image_url",
        "options": {}
      },
      "type": "n8n-nodes-base.mistralAi",
      "typeVersion": 1,
      "position": [
        640,
        -592
      ],
      "id": "bc6f6ed8-67e7-4a93-856c-7455e5baf77b",
      "name": "Extract text",
      "credentials": {
        "mistralCloudApi": {
          "id": "WZEuqlC6d4b4G4dV",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d065148f-7138-4761-b4d2-27f92dd1d502",
              "leftValue": "={{ $('Webhook Trigger1').item.binary.data.mimeType }}",
              "rightValue": "image/",
              "operator": {
                "type": "string",
                "operation": "startsWith"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        352,
        -416
      ],
      "id": "a6fbca3c-3d76-4ca3-9891-9ba69c1fb1a8",
      "name": "If"
    }
  ],
  "connections": {
    "Search Retailer": {
      "main": [
        [
          {
            "node": "Match Retailer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Match Retailer": {
      "main": [
        [
          {
            "node": "Split Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Return Item": {
      "main": [
        [
          {
            "node": "Aggregate Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Results": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Invoice Data with AI": {
      "main": [
        [
          {
            "node": "Parse Invoice Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Invoice Data": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Items": {
      "main": [
        [
          {
            "node": "Create Return Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Search Retailer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Trigger1": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract text": {
      "main": [
        [
          {
            "node": "Parse Invoice Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Extract Invoice Data with AI",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {
    "Extract text": [
      {
        "pages": [
          {
            "index": 0,
            "markdown": "Dear mypen.ge!\n\nPayment using Visa/MC with Flitt service in https://mypen.ge store was successfully paid.\n\nPayment info:\n\n|  |   |\n| --- | --- |\n|  Shop web-site: | https://mypen.ge  |\n|  Flitt transaction id: | 955593282  |\n|  Shop order ID: | 44fb0e98-3363-4efa-ba03-2b3678628576  |\n|  Client email: | dididze@gmail.com  |\n|  ь옹고ᇰ: | Mypen PRO Subscription  |\n|  Card/account number: | 5*** **** **** **29  |\n|  Payment amount: | 29.0 GEL  |\n|  Payment creation date: | 26.11.2025 09:46 GMT (Greenwich timezone)  |\n|  Authorization code: | 657231  |\n\nTo get information about this and other of your payments or print receipt please visit your Flitt personal account by link:\n\nLogin merchant portal\n\nIf you have questions relating to payments, you can contact customer support Flitt:",
            "images": [],
            "dimensions": {
              "dpi": 200,
              "height": 782,
              "width": 555
            }
          }
        ],
        "model": "mistral-ocr-2505-completion",
        "document_annotation": null,
        "usage_info": {
          "pages_processed": 1,
          "doc_size_bytes": 85024
        },
        "extractedText": "Dear mypen.ge!\n\nPayment using Visa/MC with Flitt service in https://mypen.ge store was successfully paid.\n\nPayment info:\n\n|  |   |\n| --- | --- |\n|  Shop web-site: | https://mypen.ge  |\n|  Flitt transaction id: | 955593282  |\n|  Shop order ID: | 44fb0e98-3363-4efa-ba03-2b3678628576  |\n|  Client email: | dididze@gmail.com  |\n|  ь옹고ᇰ: | Mypen PRO Subscription  |\n|  Card/account number: | 5*** **** **** **29  |\n|  Payment amount: | 29.0 GEL  |\n|  Payment creation date: | 26.11.2025 09:46 GMT (Greenwich timezone)  |\n|  Authorization code: | 657231  |\n\nTo get information about this and other of your payments or print receipt please visit your Flitt personal account by link:\n\nLogin merchant portal\n\nIf you have questions relating to payments, you can contact customer support Flitt:",
        "pageCount": 1
      }
    ]
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c0320382499acc1816c05e1130ede806d6731eecdef3b30ac30aabf4236c8764"
  }
}